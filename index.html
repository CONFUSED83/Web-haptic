<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Particle Hands Mobile</title>
    <style>
        /* Mobile-first layout */
        body { margin: 0; overflow: hidden; background-color: #000; touch-action: none; font-family: sans-serif; }
        
        /* 1. Camera Feed: Full Screen Background */
        #video-feed {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            object-fit: cover; /* Fills screen without distortion */
            z-index: 0;
            opacity: 0.3; /* Subtle background visibility */
            transform: scaleX(-1); /* Mirror effect */
        }

        /* 2. 3D Layer: sits on top */
        #canvas-container { 
            position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; 
            z-index: 1; 
        }

        /* 3. UI Overlay */
        #ui {
            position: absolute; bottom: 30px; left: 0; width: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            z-index: 10; pointer-events: none;
        }
        
        /* Status Badge */
        .status-badge {
            background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.3);
            color: #00ffcc; padding: 8px 16px; border-radius: 20px;
            font-size: 14px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;
            backdrop-filter: blur(4px);
        }

        /* Start Screen Overlay */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        
        #start-btn {
            background: linear-gradient(135deg, #00ffcc 0%, #00ccaa 100%);
            border: none; color: #000; padding: 18px 40px;
            font-size: 18px; font-weight: bold; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 255, 204, 0.3);
            margin-top: 20px; cursor: pointer;
        }
        
        .loading { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #00ffcc; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin-top: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <video id="video-feed" playsinline muted autoplay></video>
    <div id="canvas-container"></div>

    <div id="ui">
        <div class="status-badge" id="mode-badge">Initializing...</div>
        <div style="font-size: 10px; opacity: 0.7; color: white;">Pinch to Expand â€¢ Tap Cube to Switch</div>
    </div>

    <div id="start-screen">
        <h2>PARTICLE HANDS</h2>
        <p style="opacity: 0.7; max-width: 80%;">Requires Camera Access<br>Best in well-lit room</p>
        <button id="start-btn">START EXPERIENCE</button>
        <div class="loading" id="loader"></div>
    </div>

<script>
    // --- MOBILE CONFIGURATION ---
    const PARTICLE_COUNT = 1500; // Reduced for smooth mobile FPS
    const SHAPES = ['sphere', 'flower', 'heart', 'saturn', 'fireworks'];
    let currentShapeIdx = 0;
    
    // --- STATE ---
    let handDetected = false;
    let pinchVal = 1.0;
    let handPos = { x: 0, y: 0 };
    
    // --- 1. THREE.JS SETUP ---
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();
    
    // Camera Setup: Adjusted for Mobile Portrait
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
    
    // Function to adjust camera depth based on screen aspect ratio
    function adjustCameraDistance() {
        const aspect = window.innerWidth / window.innerHeight;
        // If portrait (aspect < 1), move camera back to fit the shapes
        camera.position.z = aspect < 1 ? 70 : 50; 
    }
    adjustCameraDistance();

    const renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true }); // Alpha true for transparent canvas
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Cap pixel ratio
    container.appendChild(renderer.domElement);

    // --- 2. PARTICLES ---
    const geometry = new THREE.BufferGeometry();
    const positions = new Float32Array(PARTICLE_COUNT * 3);
    const targetPositions = new Float32Array(PARTICLE_COUNT * 3);
    const colors = new Float32Array(PARTICLE_COUNT * 3);

    // Init Arrays
    for(let i=0; i<PARTICLE_COUNT; i++){
        positions[i*3] = (Math.random()-0.5)*100;
        positions[i*3+1] = (Math.random()-0.5)*100;
        positions[i*3+2] = (Math.random()-0.5)*100;
        colors[i*3] = 1; colors[i*3+1] = 1; colors[i*3+2] = 1;
    }
    geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

    const material = new THREE.PointsMaterial({
        size: 1.2, // Slightly larger for mobile visibility
        vertexColors: true,
        blending: THREE.AdditiveBlending,
        transparent: true,
        opacity: 0.9,
        depthWrite: false
    });

    const particleSystem = new THREE.Points(geometry, material);
    scene.add(particleSystem);

    // --- 3. VIRTUAL BUTTON (The "Cube") ---
    const btnGeo = new THREE.BoxGeometry(8, 8, 8); // Larger hit target
    const btnMat = new THREE.MeshBasicMaterial({ color: 0x00ffcc, wireframe: true });
    const switchBtn = new THREE.Mesh(btnGeo, btnMat);
    switchBtn.position.set(0, -25, 10); // Positioned lower for thumb reach
    scene.add(switchBtn);

    // --- SHAPE MATH ---
    function getShapePoint(type, i) {
        let x, y, z;
        const r = Math.random();
        const t = Math.random() * Math.PI * 2;
        const p = Math.acos((Math.random() * 2) - 1);

        if (type === 'sphere' || type === 'fireworks') {
            const rad = type === 'fireworks' ? 2 : 25;
            x = rad * Math.sin(p) * Math.cos(t);
            y = rad * Math.sin(p) * Math.sin(t);
            z = rad * Math.cos(p);
        } else if (type === 'heart') {
            const scale = 1.8;
            x = 16 * Math.pow(Math.sin(t), 3) * scale * Math.sqrt(r);
            y = (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * scale * Math.sqrt(r);
            z = (Math.random() - 0.5) * 8;
        } else if (type === 'flower') {
            const k = 5; // Petals
            const rad = 30 * Math.sqrt(r) * Math.cos(k * t);
            x = rad * Math.cos(t);
            y = rad * Math.sin(t);
            z = (Math.random() - 0.5) * 10;
        } else if (type === 'saturn') {
            if (i % 4 === 0) { // Planet
                x = 12 * Math.sin(p) * Math.cos(t);
                y = 12 * Math.sin(p) * Math.sin(t);
                z = 12 * Math.cos(p);
            } else { // Rings
                const dist = 22 + Math.random() * 15;
                x = dist * Math.cos(t);
                y = (Math.random()-0.5)*2;
                z = dist * Math.sin(t);
            }
        }
        return { x, y, z };
    }

    function setShape(name) {
        document.getElementById('mode-badge').innerText = name.toUpperCase();
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const pt = getShapePoint(name, i);
            targetPositions[i*3] = pt.x;
            targetPositions[i*3+1] = pt.y;
            targetPositions[i*3+2] = pt.z;
        }
    }
    setShape(SHAPES[0]);

    // --- 4. MEDIAPIPE HANDS ---
    const videoElement = document.getElementById('video-feed');
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 0, // Lite model for speed
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults((results) => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            handDetected = true;
            const lm = results.multiHandLandmarks[0];
            
            // Interaction: Hand Position (Index finger tip)
            // Remap 0..1 to -1..1
            handPos.x = (1 - lm[8].x) * 2 - 1;
            handPos.y = -(lm[8].y * 2 - 1);

            // Interaction: Pinch (Thumb tip to Index tip)
            const dx = lm[4].x - lm[8].x;
            const dy = lm[4].y - lm[8].y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            pinchVal = THREE.MathUtils.mapLinear(dist, 0.03, 0.2, 0.5, 3.0);
            pinchVal = THREE.MathUtils.clamp(pinchVal, 0.5, 4.0);

            // Button Hit Test (Simple Screen Space)
            const btnScreen = switchBtn.position.clone().project(camera);
            const distToBtn = Math.sqrt(
                Math.pow(handPos.x - btnScreen.x, 2) + 
                Math.pow(handPos.y - btnScreen.y, 2)
            );

            if (distToBtn < 0.2) {
                switchBtn.material.color.setHex(0xff0066);
                if (!switchBtn.userData.pressed) {
                    currentShapeIdx = (currentShapeIdx + 1) % SHAPES.length;
                    setShape(SHAPES[currentShapeIdx]);
                    switchBtn.userData.pressed = true;
                    setTimeout(() => switchBtn.userData.pressed = false, 1000);
                }
            } else {
                switchBtn.material.color.setHex(0x00ffcc);
            }
        } else {
            handDetected = false;
        }
    });

    // --- ANIMATION ---
    const clock = new THREE.Clock();
    let time = 0;

    function animate() {
        requestAnimationFrame(animate);
        const dt = clock.getDelta();
        time += dt;

        // Smooth Rotation
        if(handDetected) {
            particleSystem.rotation.x += (handPos.y * 0.5 - particleSystem.rotation.x) * 0.1;
            particleSystem.rotation.y += (handPos.x * 0.5 - particleSystem.rotation.y) * 0.1;
        } else {
            particleSystem.rotation.y += 0.005;
        }
        
        // Button Float
        switchBtn.rotation.x += 0.02;
        switchBtn.rotation.y += 0.02;
        switchBtn.position.y = -25 + Math.sin(time*2)*2;

        // Particle Update
        const pos = particleSystem.geometry.attributes.position.array;
        const col = particleSystem.geometry.attributes.color.array;
        
        const currentMode = SHAPES[currentShapeIdx];
        const isFireworks = currentMode === 'fireworks';
        let expand = handDetected ? pinchVal : 1.0;
        
        if (isFireworks) expand = (Math.sin(time * 3) + 1.2) * 4;

        for(let i=0; i<PARTICLE_COUNT; i++) {
            const ix = i*3;
            // Lerp Position
            pos[ix] += (targetPositions[ix] * expand - pos[ix]) * 0.08;
            pos[ix+1] += (targetPositions[ix+1] * expand - pos[ix+1]) * 0.08;
            pos[ix+2] += (targetPositions[ix+2] * expand - pos[ix+2]) * 0.08;

            // Color Update
            if (handDetected) {
                // Dynamic rainbow on hand move
                const hue = (handPos.x + 1) * 0.5 + (i/PARTICLE_COUNT) * 0.2;
                const c = new THREE.Color().setHSL(hue, 0.8, 0.6);
                col[ix] = c.r; col[ix+1] = c.g; col[ix+2] = c.b;
            } else {
                // Pulse white/blue
                col[ix] = 0.2 + Math.sin(time + i)*0.2; 
                col[ix+1] = 0.8; 
                col[ix+2] = 1.0;
            }
        }

        particleSystem.geometry.attributes.position.needsUpdate = true;
        particleSystem.geometry.attributes.color.needsUpdate = true;

        renderer.render(scene, camera);
    }

    // --- STARTUP ---
    const startBtn = document.getElementById('start-btn');
    const loader = document.getElementById('loader');

    startBtn.addEventListener('click', async () => {
        startBtn.style.display = 'none';
        loader.style.display = 'block';
        
        try {
            // Explicitly ask for User (Selfie) camera
            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => {
                    await hands.send({image: videoElement});
                },
                width: 640,
                height: 480,
                facingMode: 'user' // IMPORTANT for mobile
            });
            
            await cameraUtils.start();
            document.getElementById('start-screen').style.display = 'none';
            animate();
        } catch (e) {
            loader.style.display = 'none';
            startBtn.style.display = 'block';
            alert("Camera Error: " + e.message + "\n\n1. Use HTTPS.\n2. Allow Permissions.\n3. Try a different browser.");
        }
    });

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        adjustCameraDistance(); // Re-center for new orientation
    });

</script>
</body>
</html>
